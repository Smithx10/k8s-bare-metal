{
  variables: {
    triton_account: "{{ env `SDC_ACCOUNT` }}",
    triton_key_id: "{{ env `SDC_KEY_ID` }}",
    triton_key_path: "{{ env `SDC_KEY_PATH` }}",
    triton_url: "{{ env `SDC_URL` }}",
    triton_public_network: "{{ env `PUBLIC_NETWORK` }}",
    source_machine_package: "{{ env `SOURCE_MACHINE_PACKAGE` }}",
    image_name: "k8s-etcd-lx-16.04",
    image_version: "1.0.0",
  },
  builders: [
    {
      type: "triton",

      triton_url: "{{ user `triton_url` }}",
      triton_account: "{{ user `triton_account` }}",
      triton_key_id: "{{ user `triton_key_id` }}",
      triton_key_material: "{{ user `triton_key_path` }}",
      source_machine_name: "k8s-etcd-lx-builder",
      source_machine_package: "{{ user `source_machine_package` }}",
      source_machine_image: "7b5981c4-1889-11e7-b4c5-3f3bdfc9b88b",

      // Public Network for Building
      source_machine_networks: [
        "{{ user `triton_public_network` }}",
      ],

      // `root` user for Joyent ubuntu images
      ssh_username: "root",
      ssh_private_key_file: "{{ user `triton_key_path` }}",
      ssh_bastion_username: "root",
      ssh_bastion_host: "{{ user `triton_bastion_host` }}",
      ssh_bastion_private_key_file: "{{ user `triton_key_path` }}",

      image_name: "{{ user `image_name` }}",
      image_version: "{{ user `image_version` }}",
    },
  ],

  provisioners: [
    {
      type: "file",
      source: "templates/etcd-bootstrap.service",
      destination: "/lib/systemd/system/etcd-bootstrap.service",
    },
    {
      type: "file",
      source: "templates/etcd.service",
      destination: "/lib/systemd/system/etcd.service",
    },
    { // Clean up the base Ubuntu image
      type: "shell",
      "environment_vars": [
        "ETCD_VERSION=v3.2.0",
	"RELEASE_URL=https://github.com/coreos/etcd/releases/download",
	"ETCD_CHECKSUM=a26c7de7994d295541bf20f6e09f7e6afa81c45b"
      ],
      inline: [
        // Log the version of the builder image
        "uname -a",
        // Update packaging
        "sudo apt-get update",
        // Additional packages for management
        "sudo apt-get install -y bash python-minimal curl",
	// Grab etcd and untar it 
	"sudo curl -Lso /tmp/etcd.tar.gz ${RELEASE_URL}/${ETCD_VERSION}/etcd-${ETCD_VERSION}-linux-amd64.tar.gz",
	"sudo ls -lt /tmp",
	"sudo echo ${ETCD_CHECKSUM} /tmp/etcd.tar.gz | sha1sum -c",
	"sudo tar zxf /tmp/etcd.tar.gz -C /tmp",
	"sudo mv /tmp/etcd-${ETCD_VERSION}-linux-amd64/etcd* /usr/local/bin/",
	"sudo systemctl daemon-reload"
      ],
    },
  ],
}
