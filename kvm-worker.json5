// This Packer Template requires JSON5 support in packer(1) or the cfgt(1)
// utility.
//
// USAGE with unpatched packer: cfgt -i kvm-worker.json5 | packer build -
// USAGE with patched packer: packer build kvm-worker.json5
//
// packer w/ JSON5 support: https://github.com/sean-/packer/tree/f-json5
// cfgt: go get -u github.com/sean-/cfgt
{
  variables: {
    // Environment variables pulled from `triton env` or `triton env $(PROFILE_NAME)`
    triton_account: "{{ env `SDC_ACCOUNT` }}",
    triton_key_id: "{{ env `SDC_KEY_ID` }}",
    triton_key_path: "{{ env `SDC_KEY_PATH` }}",
    triton_url: "{{ env `SDC_URL` }}",
    image_name: "k8s-worker-kvm-16.04",
    image_version: "1.0.0",
  },

  builders: [
    {
      type: "triton",

      triton_url: "{{ user `triton_url` }}",
      triton_account: "{{ user `triton_account` }}",
      triton_key_id: "{{ user `triton_key_id` }}",
      triton_key_material: "{{ user `triton_key_path` }}",

      source_machine_name: "k8s-worker-kvm-builder",
      source_machine_package: "k4-highcpu-kvm-1.75G",
      source_machine_image: "554abb2e-a957-4b51-a601-97c934eadf33",

      // Private network for control plane only
      source_machine_networks: [
        "0aa8f3f0-dddf-4449-ae4c-1289d60f33f9",
      ],

      ssh_username: "root",
      ssh_private_key_file: "{{ user `triton_key_path` }}",

      ssh_bastion_host: "fubarnetes",
      ssh_bastion_username: "ubuntu",
      ssh_bastion_private_key_file: "{{ user `triton_key_path` }}",

      image_name: "{{ user `image_name` }}",
      image_version: "{{ user `image_version` }}",
    },
  ],

  provisioners: [
    { // Clean up the base Ubuntu image
      type: "shell",
      inline: [
        // Log the version of the builder image
        "uname -a",
        // Update packaging
        "apt-get update",
        // Additional packages for management
        "apt-get install -y bash tmux wget curl jq ca-certificates",
        // Install Docker 1.12.1
        "wget --no-verbose https://get.docker.com/builds/Linux/x86_64/docker-1.12.1.tgz && tar -xvf docker-1.12.1.tgz && cp docker/docker* /usr/bin/",
        // Install kubelet

      ],
    },
  ],
}
